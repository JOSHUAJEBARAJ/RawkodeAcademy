apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

commonAnnotations:
  pulumi.com/skipAwait: "true"

resources:
  - argocdk8s.yaml
  - https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
  - platform.yaml

patchesStrategicMerge:
  - |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: argocd-repo-server
    spec:
      template:
        spec:
          volumes:
            - name: cmp-plugin
              configMap:
                name: argocdk8s
            - emptyDir: {}
              name: cmp-tmp
          containers:
            - name: argocd-repo-server
            - name: argocdk8s
              image: node:current-alpine
              command: ["ash", "-c"]
              args:
                - yarn global add cdk8s-cli && /var/run/argocd/argocd-cmp-server
              securityContext:
                runAsNonRoot: true
                runAsUser: 999
              env:
                - name: HOME
                  value: /tmp/
                - name: NPM_CONFIG_PREFIX
                  value: /tmp/node/.npm-global
                - name: YARN_CACHE_FOLDER
                  value: /tmp/yarn
              volumeMounts:
                - mountPath: /var/run/argocd
                  name: var-files
                - mountPath: /home/argocd/cmp-server/plugins
                  name: plugins
                - mountPath: /home/argocd/cmp-server/config/plugin.yaml
                  subPath: plugin.yaml
                  name: cmp-plugin
                - mountPath: /tmp
                  name: cmp-tmp
